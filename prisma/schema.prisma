generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* ============================
   USER
============================= */

model User {
  nik                     String        @id
  nomor_identitas_tunggal String        @unique
  email                   String        @unique
  password                String
  nama                    String
  role                    Role          @default(civitas_faste)
  createdAt               DateTime      @default(now())
  updateAt                DateTime      @updatedAt

  peminjamanP             PeminjamanP[]
  barangUnit              BarangUnit[]
}

/* ============================
   DATA BARANG UTAMA
============================= */

model DataBarang {
  kode_barang  String       @id
  jenis_barang String
  merek        String
  barangUnit   BarangUnit[]
}

/* ============================
   DATA LOKASI
============================= */

model DataLokasi {
  kode_lokasi String        @id
  lokasi      String
  status      StatusLokasi  @default(tidakDipinjam)

  barangUnit  BarangUnit[]
  peminjamanP PeminjamanP[]
  monitoring  Monitoring[]
}

/* ============================
   UNIT BARANG (1 PER NUP)
============================= */

model BarangUnit {
  nup         String        @id
  kodeBarang  String
  lokasi      String
  nikUser     String
  status      StatusB       @default(Tersedia)
  createdAt   DateTime      @default(now())

  // relasi
  dataBarang  DataBarang    @relation(fields: [kodeBarang], references: [kode_barang])
  dataLokasi  DataLokasi    @relation(fields: [lokasi], references: [kode_lokasi])
  user        User          @relation(fields: [nikUser], references: [nik])
  monitoring  Monitoring[]

  // relasi peminjaman baru
  peminjamanItems PeminjamanItem[]
}

/* ============================
   PEMINJAMAN (LOKASI / BMN)
============================= */

model PeminjamanP {
  id             Int           @id @default(autoincrement())
  userNik        String
  kodeLokasi     String?
  lokasiTambahan String?
  no_hp          String
  createdAt      DateTime      @default(now())
  Agenda         String
  waktuMulai     DateTime
  waktuSelesai   DateTime
  verifikasi     StatusBooking @default(pending)
  status         StatusP       @default(booking)

  // —————— Relasi ——————
  user           User          @relation(fields: [userNik], references: [nik])
  lokasi         DataLokasi?   @relation(fields: [kodeLokasi], references: [kode_lokasi])

  // relasi baru: banyak barang dalam 1 peminjaman
  items          PeminjamanItem[]

  // FIELD LAMA (supaya data lama aman)
  // Setelah migrasi dan data dipindah, baru hapus.
  barangUnitId   String?
  qrCode   String?   // QR code base64 / url
}

/* ============================
   PEMINJAMAN ITEM (JOIN TABLE)
   — banyak barang per peminjaman
============================= */

model PeminjamanItem {
  id             Int          @id @default(autoincrement())
  peminjamanId   Int
  nupBarang      String

  peminjaman     PeminjamanP  @relation(fields: [peminjamanId], references: [id])
  barangUnit     BarangUnit   @relation(fields: [nupBarang], references: [nup])

  @@index([peminjamanId])
  @@index([nupBarang])
}

/* ============================
   MONITORING KONDISI BARANG
============================= */

model Monitoring {
  id             String         @id
  nupBarang      String
  waktu          DateTime
  plt            String
  kondisiBarang  KondisiBarangM @default(baik)
  lokasiBarang   String?
  lokasiTambahan String?
  foto           String
  keterangan     String?

  barangUnit     BarangUnit     @relation(fields: [nupBarang], references: [nup])
  dataLokasi     DataLokasi?    @relation(fields: [lokasiBarang], references: [kode_lokasi])
}

/* ============================
   ENUM
============================= */

enum Role {
  civitas_faste
  staff
  kepala_bagian_akademik
  staff_prodi
}

enum StatusBooking {
  pending
  diterima
  ditolak
}

enum StatusP {
  booking
  aktif
  selesai
  batal
}

enum StatusB {
  Tersedia
  TidakTersedia
}

enum KondisiBarangM {
  baik
  rusak_ringan
  rusak_berat
}

enum StatusLokasi {
  dipinjam
  tidakDipinjam
  belumTersedia
}
